<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="SuPQ3DDNV0"><meta name="author" content="Minhui Zheng, mattzhengjob@gmail.com"><title>é€šè¿‡ confine ç ”ç©¶ tooltip çš„å®ç°è¿‡ç¨‹ -- eCharts æºç è§£è¯» Â· Minhui's blog</title><meta name="description" content="å®ç°ä¸šåŠ¡éœ€æ±‚æ—¶å‘ç° tooltip ä¸­å‘ˆç°çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œå½“å‡ºç°åœ¨è¾¹ç•Œæ—¶ä¼šå‡ºç°ä¸€éƒ¨åˆ†åœ¨å¯è§†èŒƒå›´ä»¥å¤–ã€‚æ‰€å¹¸ echarts æä¾›äº†ä¸€ä¸ª confine é…ç½®ç»™ tooltipï¼Œå½“ä¸º true æ—¶ï¼Œå¯ä»¥å¼ºåˆ¶ä½¿ tooltip å‡ºç°åœ¨ view è§†å›¾ä¸­ã€‚
æ¥ä¸‹æ¥æ¥çœ‹çœ‹æºç ä¸­æ˜¯æ€æ ·å®ç° confine åŠŸèƒ½çš„"><meta name="keywords" content="React,Next.js,Svelte,Web,HTML,JavaScript,CSS,Tailwind,Frontend,Angular"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no"><meta name="og:type" content="blog"><meta name="og:title" content="Minhui's blog"><meta name="og:description" content="I'm Minhui and I share my thoughts about reading, thinking, and web development."><meta name="og:image" content="https://zhengminhui.com/images/og-image-logo.png"><meta name="twitter:card" content="summary"><meta name="twitter:description" content="I'm Minhui and I share my thoughts about reading, thinking, and web development."><meta name="twitter:site" content="https://zhengminhui.com/"><meta name="twitter:creator" content="@minhui"><meta name="twitter:image" content="https://zhengminhui.com/images/og-image-logo.png"><meta name="renderer" content="webkit"><link type="image/png" href="https://zhengminhui.com/images/favicon16.png" rel="icon" size="16x16"><link type="image/png" href="https://zhengminhui.com/images/favicon32.png" rel="icon" size="32x32"><link href="/css/style.css" rel="stylesheet"><link href="/css/blog_basic.css" rel="stylesheet"><link href="/css/font-awesome.min.css" rel="stylesheet"><link type="application/atom+xml" href="/atom.xml" title="ATOM 1.0" rel="alternate"><script src="/_vercel/insights/script.js" defer=""></script><script src="https://www.googletagmanager.com/gtag/js?id=G-36J5NZ3PJY" async=""></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-36J5NZ3PJY');</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:128px;"><h3 title=""><a href="/">Minhui's blog</a></h3><div class="description"><p>ğŸ–– Live long and prosper.</p></div></div></div><ul class="social-links"><li><a href="https://github.com/zhengminhui" target="_blank"><i class="fa fa-github"></i></a></li><li><a href="http://instagram.com/wanzaiwanger" target="_blank"><i class="fa fa-instagram"></i></a></li><li><a href="http://weibo.com/alandwhatever" target="_blank"><i class="fa fa-weibo"></i></a></li><li><a href="https://twitter.com/wanzaiwanger" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://zhengminhui.com/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li></ul><div class="footer"><span>Theme by CaiCai & Ben</span><div class="by_farbox"><span>Proudly published with Hexo</span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>é€šè¿‡ confine ç ”ç©¶ tooltip çš„å®ç°è¿‡ç¨‹ -- eCharts æºç è§£è¯»</a></h3></div><div class="post-content"><p>å®ç°ä¸šåŠ¡éœ€æ±‚æ—¶å‘ç° tooltip ä¸­å‘ˆç°çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œå½“å‡ºç°åœ¨è¾¹ç•Œæ—¶ä¼šå‡ºç°ä¸€éƒ¨åˆ†åœ¨å¯è§†èŒƒå›´ä»¥å¤–ã€‚æ‰€å¹¸ echarts æä¾›äº†ä¸€ä¸ª confine é…ç½®ç»™ tooltipï¼Œå½“ä¸º true æ—¶ï¼Œå¯ä»¥å¼ºåˆ¶ä½¿ tooltip å‡ºç°åœ¨ view è§†å›¾ä¸­ã€‚</p>
<p>æ¥ä¸‹æ¥æ¥çœ‹çœ‹æºç ä¸­æ˜¯æ€æ ·å®ç° confine åŠŸèƒ½çš„ã€‚</p>
<p>é¦–å…ˆå¯ä»¥çœ‹åˆ°ï¼Œconfine æ˜¯åœ¨ <code>src/component/tooltip/TooltipModel.js</code> ä¸­å®šä¹‰ï¼Œé»˜è®¤å€¼æ˜¯ <code>false</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜¯å¦çº¦æŸ content åœ¨ viewRect ä¸­ã€‚é»˜è®¤ false æ˜¯ä¸ºäº†å…¼å®¹ä»¥å‰ç‰ˆæœ¬ã€‚</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> echarts.<span class="title function_">extendComponentModel</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;tooltip&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">dependencies</span>: [<span class="string">&#x27;axisPointer&#x27;</span>],</span><br><span class="line"></span><br><span class="line">  <span class="attr">defaultOption</span>: &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// &#x27;trigger&#x27; only works on coordinate system.</span></span><br><span class="line">    <span class="comment">// &#x27;item&#x27; | &#x27;axis&#x27; | &#x27;none&#x27;</span></span><br><span class="line">    <span class="attr">trigger</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">    <span class="comment">// &#x27;click&#x27; | &#x27;mousemove&#x27; | &#x27;none&#x27;</span></span><br><span class="line">    <span class="attr">triggerOn</span>: <span class="string">&#x27;mousemove|click&#x27;</span>,</span><br><span class="line">    <span class="comment">// æ˜¯å¦çº¦æŸ content åœ¨ viewRect ä¸­ã€‚é»˜è®¤ false æ˜¯ä¸ºäº†å…¼å®¹ä»¥å‰ç‰ˆæœ¬ã€‚</span></span><br><span class="line">    <span class="attr">confine</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå¯ä»¥çœ‹åˆ°åœ¨åŒçº§ç›®å½•ä¸‹çš„ <code>TooltipView.js</code> æ–‡ä»¶ï¼Œè¿™é‡Œè´Ÿè´£å®šä¹‰äº† TooltipView ç›¸å…³çš„æ˜¾ç¤ºã€éšè—ã€æ›´æ–°ä½ç½®ç­‰çš„æ–¹æ³•ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­æœç´¢ confineï¼Œå‘ç°ç›¸å…³ä»£ç ä¸»è¦æ˜¯ä¸¤å¤„ï¼Œä¸€å¤„æ˜¯ <code>confineTooltipPosion</code> functionï¼Œè¿™é‡Œå¾ˆå¥½ç†è§£ï¼Œé€šè¿‡è®¡ç®—å½“å‰ xã€y å€¼ï¼Œå’Œå½“å‰çš„å¯è§†èŒƒå›´çš„å®½é«˜ viewWidth, viewHeight æ¯”è¾ƒï¼Œå¾—åˆ° confine ä¹‹åæ–°çš„ xã€y å€¼ã€‚ å¦ä¸€å¤„åˆ™æ˜¯è°ƒç”¨<code>confineTooltipPosion</code>çš„ <code>_updatePosition</code> æ–¹æ³•.</p>
<p>åœ¨è¿™é‡Œï¼Œä¸€å…±å®šä¹‰äº†ä¸‰ç§ showTooltip æ–¹æ³•ï¼Œå¯¹åº”ä¸åŒçš„å¯¹è±¡ã€‚åˆ†åˆ«æ˜¯ _showAxisTooltip, _showComponentItemTooltip å’Œ _showSeriesItemTooltip . æˆ‘ä»¬åªå…³æ³¨ series ä¸­ item çš„ tooltipï¼Œ è‡³äº AxisTooltip å’Œ ComponentItemTooltipï¼Œåœ¨åŸç†ä¸ŠåŸºæœ¬ä¸€è‡´ã€‚</p>
<p>æ¢³ç†ä¸€ç•ªä¹‹åå‘ç°ï¼Œåœ¨è¯¥ç±»ä¸­ï¼Œæ–¹æ³•çš„è°ƒç”¨é“¾æ˜¯ <code>confineTooltipPosion</code> -&gt; <code>_updatePosition</code> -&gt; <code>_showTooltipContent</code> -&gt; <code>_showSeriesItemTooltip</code> -&gt; <code>_tryShow</code> -&gt; <code>_initGlobalListener</code> -&gt; <code>render</code>. æ‰§è¡Œé¡ºåºæ˜¯ä»å³è‡³å·¦ã€‚</p>
<p>ç†æ¸…äº†æ€è·¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä»£ç æ˜¯å¦‚ä½•å®ç° confine çš„è¿‡ç¨‹ã€‚</p>
<p>å¼„æ¸…äº†æ‰§è¡Œé¡ºåºåï¼Œå°±å¾ˆå¥½ç†è§£ tooltip çš„æ¸²æŸ“è¿‡ç¨‹äº†ã€‚åœ¨ç”Ÿå‘½å‘¨æœŸ render å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº† <code>_initGlobalListener</code>ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œ å¯ä»¥è·å–åˆ°ä¸€ä¸ªå…±äº«çš„å…¨å±€ç›‘å¬å™¨ <code>globalListener</code>. è¿™ä¸ªç›‘å¬å™¨å…·ä½“å®ç°å’Œå±æ€§å¯å‚è§<code>src/component/axisPointer/globalListener.js</code>ã€‚ è¿™é‡Œæˆ‘ä»¬å…ˆå…³æ³¨æš´éœ²å‡ºæ¥çš„ <code>register</code>æ–¹æ³•ï¼Œä»–æ¥å—ä¸‰ä¸ª arguments: <code>function register(key, api, handler)</code>; æ‰€ä»¥è¿™é‡Œå°±å¾ˆå¥½ç†è§£äº†ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œåˆ¤æ–­ tooltip çš„è§¦å‘æ¡ä»¶ï¼ˆtriggerOn:â€™clickâ€™ | â€˜mousemoveâ€™ | â€˜noneâ€™ ï¼‰ï¼Œ å¦‚æœä¸æ˜¯<code>none</code>ï¼Œ åˆ™ globalListener ç»™<code>itemTooltip</code> æ³¨å†Œäº†å›è°ƒ handlerã€‚å½“ <code>currTrigger</code>æ˜¯ <code>click</code>æˆ–<code>mousemove</code> æ—¶ï¼Œè°ƒç”¨ <code>_tryShow</code> æ˜¾ç¤º tooltipï¼Œå½“ leave æ—¶è°ƒç”¨ <code>_hide</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// _initGlobalListener</span></span><br><span class="line"><span class="keyword">var</span> tooltipModel = <span class="variable language_">this</span>.<span class="property">_tooltipModel</span>;</span><br><span class="line"><span class="keyword">var</span> triggerOn = tooltipModel.<span class="title function_">get</span>(<span class="string">&#x27;triggerOn&#x27;</span>);</span><br><span class="line"></span><br><span class="line">globalListener.<span class="title function_">register</span>(</span><br><span class="line">  <span class="string">&#x27;itemTooltip&#x27;</span>,</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_api</span>,</span><br><span class="line">  <span class="title function_">bind</span>(<span class="keyword">function</span>(<span class="params">currTrigger, e, dispatchAction</span>) &#123;</span><br><span class="line">    <span class="comment">// If &#x27;none&#x27;, it is not controlled by mouse totally.</span></span><br><span class="line">    <span class="keyword">if</span> (triggerOn !== <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (triggerOn.<span class="title function_">indexOf</span>(currTrigger) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_tryShow</span>(e, dispatchAction);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currTrigger === <span class="string">&#x27;leave&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_hide</span>(dispatchAction);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="variable language_">this</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>tryShow è°ƒç”¨å, æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å®ç°éå¸¸ç›´è§‚ï¼Œæ ¹æ®æ¡ä»¶æ¥åˆ¤æ–­æ˜¾ç¤º seriesã€component è¿˜æ˜¯ axis çš„ tooltipã€‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨_showSeriesItemTooltip.</p>
<p>èµ°åˆ°_showSeriesItemTooltipï¼Œè¿™ä¸ªå‡½æ•°å£°æ˜å¹¶è®¡ç®—äº†ä¸€ç³»åˆ—çš„å˜é‡ï¼Œéƒ½æ˜¯ä¸ºäº† function _showTooltipContent çš„å‚æ•°åšå‡†å¤‡ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="title function_">_showOrMove</span>(tooltipModel, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_showTooltipContent</span>(</span><br><span class="line">    tooltipModel,</span><br><span class="line">    defaultHtml,</span><br><span class="line">    params,</span><br><span class="line">    asyncTicket,</span><br><span class="line">    e.<span class="property">offsetX</span>,</span><br><span class="line">    e.<span class="property">offsetY</span>,</span><br><span class="line">    e.<span class="property">position</span>,</span><br><span class="line">    e.<span class="property">target</span>,</span><br><span class="line">    markers,</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ç»“åˆ echarts tooltip çš„æ–‡æ¡£å’Œ tooltipModel æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªé…ç½®å‚æ•° showDelayï¼Œå¦‚æœ delay å¤§äº 0 åˆ™ setTimeoutï¼Œè‹¥å¹²ç§’åæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œåœ¨è¿™é‡Œåˆ™æ˜¯æ˜¾ç¤º toolTipï¼ˆ _showTooltipContentï¼‰ï¼›å¦åˆ™ç«‹å³æ‰§è¡Œ callbackã€‚ä¸è¿‡å®˜æ–¹æ–‡æ¡£å¹¶ä¸å»ºè®®è®¾ç½® delayã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤ä¸º_showOrMove æ˜¯ä¸ªå®šæ—¶å™¨ï¼Œåˆ°äº†æ—¶é—´åæ˜¾ç¤º tooltipã€‚_showOrMove å®ç°å¦‚ä¸‹ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_showOrMove</span></span><br><span class="line"><span class="comment">// showDelay is used in this case: tooltip.enterable is set</span></span><br><span class="line"><span class="comment">// as true. User intent to move mouse into tooltip and click</span></span><br><span class="line"><span class="comment">// something. `showDelay` makes it easyer to enter the content</span></span><br><span class="line"><span class="comment">// but tooltip do not move immediately.</span></span><br><span class="line"><span class="keyword">var</span> delay = tooltipModel.<span class="title function_">get</span>(<span class="string">&#x27;showDelay&#x27;</span>);</span><br><span class="line">cb = zrUtil.<span class="title function_">bind</span>(cb, <span class="variable language_">this</span>);</span><br><span class="line"><span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">_showTimout</span>);</span><br><span class="line">delay &gt; <span class="number">0</span> ? (<span class="variable language_">this</span>.<span class="property">_showTimout</span> = <span class="built_in">setTimeout</span>(cb, delay)) : <span class="title function_">cb</span>();</span><br></pre></td></tr></table></figure>

<p>å›åˆ°_showTooltipContentï¼Œ åœ¨è¿™ä¸ªæ–¹æ³•é‡Œæˆ‘ä»¬çŸ¥é“äº† echarts å¦‚ä½•å…¼å®¹ formatterï¼Œä¼ å…¥ string å’Œ function æ—¶ä¸åŒçš„å¤„ç†æ–¹æ³•ã€‚é€šè¿‡ typeof åˆ¤æ–­åï¼Œå¦‚æœæ˜¯ stringï¼Œ åˆ™é€šè¿‡ <code>formatUtil.formatTpl</code> ç›´æ¥ replace, return ä¸€ä¸ª tpl<string>; å¦‚æœ typeof æ˜¯ functionï¼Œ åˆ™é€šè¿‡ <code>.innerHTML</code> æ’å…¥ä¸€æ®µæ–°çš„ string.</p>
<p>å…³é”®ä»£ç å¦‚ä¸‹, å®ç°é€»è¾‘åœ¨è¿™é‡Œå°±ä¸è¿‡å¤šå…³æ³¨äº†ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// is string formatTpl</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Template formatter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">tpl</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array.&lt;Object&gt;|Object</span>&#125; <span class="variable">paramsList</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">boolean</span>&#125; [encode=false]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">string</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">formatTpl</span>(<span class="params">tpl, paramsList, encode</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!zrUtil.<span class="title function_">isArray</span>(paramsList)) &#123;</span><br><span class="line">    paramsList = [paramsList];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> seriesLen = paramsList.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">if</span> (!seriesLen) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> $vars = paramsList[<span class="number">0</span>].<span class="property">$vars</span> || [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; $vars.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> alias = <span class="variable constant_">TPL_VAR_ALIAS</span>[i];</span><br><span class="line">    tpl = tpl.<span class="title function_">replace</span>(<span class="title function_">wrapVar</span>(alias), <span class="title function_">wrapVar</span>(alias, <span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> seriesIdx = <span class="number">0</span>; seriesIdx &lt; seriesLen; seriesIdx++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; $vars.<span class="property">length</span>; k++) &#123;</span><br><span class="line">      <span class="keyword">var</span> val = paramsList[seriesIdx][$vars[k]];</span><br><span class="line">      tpl = tpl.<span class="title function_">replace</span>(</span><br><span class="line">        <span class="title function_">wrapVar</span>(<span class="variable constant_">TPL_VAR_ALIAS</span>[k], seriesIdx),</span><br><span class="line">        encode ? <span class="title function_">encodeHTML</span>(val) : val,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tpl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// is function, setContent</span></span><br><span class="line"><span class="attr">setContent</span>: <span class="keyword">function</span> (<span class="params">content</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">el</span>.<span class="property">innerHTML</span> = content == <span class="literal">null</span> ? <span class="string">&#x27;&#x27;</span> : content;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ’ä¸€ä¸ªé¢˜å¤–è¯ï¼Œ HTML5 è§„èŒƒä¸­è¡¨ç¤º <code>&lt;script&gt;</code> tag ä¸­çš„å†…å®¹åœ¨ä½¿ç”¨ <code>innerHTML</code> æ’å…¥æ—¶æ˜¯ä¸åº”è¯¥è¢«æ‰§è¡Œçš„</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name = <span class="string">&quot;&lt;script&gt;alert(&#x27;I am John in an annoying alert!&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line"> el.<span class="property">innerHTML</span> = name; <span class="comment">// harmless in this case</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å½“ä¸ä½¿ç”¨ <code>&lt;script&gt;</code> tag å¹¶ä½¿ç”¨ innerHTML æ’å…¥ string æ—¶ï¼Œåˆ™ä¼šæœ‰ croos-site scripting attact é£é™©</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">&quot;&lt;img src=&#x27;x&#x27; onerror=&#x27;alert(1)&#x27;&gt;&quot;</span>;</span><br><span class="line">el.<span class="property">innerHTML</span> = name; <span class="comment">// shows the alert</span></span><br></pre></td></tr></table></figure>

<p>åŸºäºè¿™ä¸ªåŸå› ï¼Œæ¨èä½¿ç”¨ <code>Node.textContent</code> è€Œä¸æ˜¯ä½¿ç”¨ <code>innerHTML</code></p>
<p>å¥½äº†ï¼Œç»ˆäºç”Ÿæˆäº† contentï¼Œå’Œéœ€è¦çš„åæ ‡ã€å‚æ•°ç­‰ï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨äº† _updatePosition. åœ¨_updatePosition ä¸­æˆ‘ä»¬çœ‹åˆ° echats æ˜¯å¦‚ä½•å»åšå½“ position å­—æ®µä¼ å…¥ string, array å’Œ function æ—¶çš„å¤„ç†æ–¹æ³•çš„ã€‚å¦‚æœå¯¹è¿™é‡Œæ„Ÿå…´è¶£å¯ä»¥å…³æ³¨ä¸€ä¸‹ã€‚ åœ¨è¿™ä¸ªæ–¹æ³•çš„æœ€åï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¯¹ confine çš„åˆ¤æ–­ï¼Œå¦‚æœä¸º trueï¼Œåˆ™å†æ¬¡è°ƒç”¨ confineTooltipPosition, è¿”å›æ–°çš„ xï¼Œy åæ ‡ã€‚ç„¶åå°† content ç§»åŠ¨åˆ°æ–°çš„åæ ‡ä½ç½®ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> viewWidth = <span class="variable language_">this</span>.<span class="property">_api</span>.<span class="title function_">getWidth</span>();</span><br><span class="line"><span class="keyword">var</span> viewHeight = <span class="variable language_">this</span>.<span class="property">_api</span>.<span class="title function_">getHeight</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tooltipModel.<span class="title function_">get</span>(<span class="string">&#x27;confine&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">var</span> pos = <span class="title function_">confineTooltipPosition</span>(x, y, content, viewWidth, viewHeight);</span><br><span class="line">  x = pos[<span class="number">0</span>];</span><br><span class="line">  y = pos[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">content.<span class="title function_">moveTo</span>(x, y);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçœ‹åˆ° echarts è·å–å¯è§†èŒƒå›´çš„é«˜å®½ï¼Œæ˜¯é€šè¿‡å°è£…åœ¨å†…çš„ _api å†…çš„æ–¹æ³•è·å¾—ã€‚è¿™é‡Œæ¶‰åŠåˆ°æ›´åº•å±‚çš„å…³äº echarts è°ƒç”¨ zrender ç”Ÿæˆ root ç»˜å›¾å®¹å™¨çš„è¿‡ç¨‹ï¼ŒåŸºæœ¬åŸç†æ˜¯å…ˆè·å–ç»˜å›¾åŒºåŸŸå®ä¾‹ï¼Œæ ¹æ®è¯¥å®ä¾‹å†è·å–é«˜å®½ã€‚å…·ä½“è¿‡ç¨‹åœ¨æ­¤ä¸ä½œèµ˜è¿°ã€‚ç•™ä¸ªè®°å½•ï¼Œæœ‰æœºä¼šå†æ¥è§£æé‚£ä¸€éƒ¨åˆ†ã€‚å…·ä½“ä»£ç å¯ä»¥å‚è€ƒ <code>zrender/src/Painter.js</code>.</p>
<p>å›åˆ° <code>confineTooltipPosition</code> æ–¹æ³•ï¼Œ æ ¹æ®å‰é¢æ–¹æ³•çš„å®šä¹‰ï¼Œè¿™é‡Œçš„ xï¼Œy æ˜¯ e.offsetX å’Œ e.offsetY. è¡¨ç¤ºäº‹ä»¶å‘ç”Ÿæ—¶é¼ æ ‡ pointer åˆ° target node çš„ padding çš„è·ç¦»ã€‚ è€Œ width å’Œ height åˆ†åˆ«æ˜¯ clientWidth å’Œ clientHeight åŠ ä¸Š borderWidth. é€šè¿‡ä½ç½®çš„å¤§å°æ¯”è¾ƒï¼Œå¯ä»¥ä¿è¯æ–°çš„ content å¤„äºå¯è§†åŒºåŸŸå†…ã€‚ç¬¬ä¸€ä¸ª x åˆ¤æ–­æ˜¯å¦å³è¾¹æº¢å‡ºï¼Œç¬¬äºŒä¸ª x åˆ¤æ–­æ˜¯å¦å·¦è¾¹æº¢å‡ºã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">confineTooltipPosition</span>(<span class="params">x, y, content, viewWidth, viewHeight</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> size = content.<span class="title function_">getOuterSize</span>();</span><br><span class="line">  <span class="keyword">var</span> width = size.<span class="property">width</span>;</span><br><span class="line">  <span class="keyword">var</span> height = size.<span class="property">height</span>;</span><br><span class="line"></span><br><span class="line">  x = <span class="title class_">Math</span>.<span class="title function_">min</span>(x + width, viewWidth) - width;</span><br><span class="line">  y = <span class="title class_">Math</span>.<span class="title function_">min</span>(y + height, viewHeight) - height;</span><br><span class="line">  x = <span class="title class_">Math</span>.<span class="title function_">max</span>(x, <span class="number">0</span>);</span><br><span class="line">  y = <span class="title class_">Math</span>.<span class="title function_">max</span>(y, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [x, y];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">getOuterSize</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> width = <span class="variable language_">this</span>.<span class="property">el</span>.<span class="property">clientWidth</span>;</span><br><span class="line">    <span class="keyword">var</span> height = <span class="variable language_">this</span>.<span class="property">el</span>.<span class="property">clientHeight</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Consider browser compatibility.</span></span><br><span class="line">    <span class="comment">// IE8 does not support getComputedStyle.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">defaultView</span> &amp;&amp; <span class="variable language_">document</span>.<span class="property">defaultView</span>.<span class="property">getComputedStyle</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> stl = <span class="variable language_">document</span>.<span class="property">defaultView</span>.<span class="title function_">getComputedStyle</span>(<span class="variable language_">this</span>.<span class="property">el</span>);</span><br><span class="line">        <span class="keyword">if</span> (stl) &#123;</span><br><span class="line">            width += <span class="built_in">parseInt</span>(stl.<span class="property">borderLeftWidth</span>, <span class="number">10</span>) + <span class="built_in">parseInt</span>(stl.<span class="property">borderRightWidth</span>, <span class="number">10</span>);</span><br><span class="line">            height += <span class="built_in">parseInt</span>(stl.<span class="property">borderTopWidth</span>, <span class="number">10</span>) + <span class="built_in">parseInt</span>(stl.<span class="property">borderBottomWidth</span>, <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">width</span>: width, <span class="attr">height</span>: height&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠ content ç§»åŠ¨åˆ°æ–°ç”Ÿæˆçš„åæ ‡ä¸Šï¼Œè‡³æ­¤å°±å®Œæˆäº† confine çš„åŠŸèƒ½ã€‚</p>
<p>æœ€åè¯´ä¸€ä¸ªçœ‹ä»£ç çš„å¿ƒå¾—ï¼Œå¹³å¸¸åœ¨å®ç°ä¸€äº›å…¬å…± sdk æ—¶ï¼Œç»å¸¸éœ€è¦æš´éœ²ä¸€äº› apiï¼Œæœ‰çš„æ—¶å€™çœ‹åˆ°ç›´æ¥å®šä¹‰çš„æ˜¯ä¸€ä¸ª arrayï¼Œç„¶åè°ƒç”¨æ–¹ä½¿ç”¨ <code>array[index]</code> å»è·å–æŸä¸ªæ–¹æ³•ã€‚è¿™æ ·çš„åå¤„ä¸€ä¸ªæ˜¯æ•°ç»„çš„é¡ºåºæ— æ³•ä¿è¯ï¼Œå¢ã€åˆ ä¹‹å index å¯èƒ½ä¼šå˜ï¼Œç»™è°ƒç”¨æ–¹é€ æˆå½±å“ã€‚å¦å¤–ä¸€ä¸ªæ˜¯ï¼Œé€šè¿‡ index è·å–æ—¶ï¼Œå¯¹è°ƒç”¨çš„æ–¹æ³•åæ„ŸçŸ¥ä¸åˆ°ï¼Œä¸èƒ½ç¡®ä¿ä½¿ç”¨çš„æ–¹æ³•æ˜¯å¦æ­£ç¡®ã€‚ echarts ä¸­çš„è¿™ä¸ªå®ç°æ¯”è¾ƒä¼˜é›…ï¼ŒapiList å’ŒçœŸæ­£æš´éœ²ä½¿ç”¨çš„ api å¯¹è±¡è§£è€¦ã€‚é€šè¿‡éå† apiListï¼Œ äº§ç”Ÿä¸€ä¸ªåŒ…å« apiList å…ƒç´ ä¸º key çš„å¯¹è±¡ï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œä½¿ç”¨å‡½æ•°åï¼Œæ›´ç›´è§‚ï¼Œæ›´å‹å¥½ï¼Œå€¼å¾—å­¦ä¹ ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> zrUtil <span class="keyword">from</span> <span class="string">&#x27;zrender/src/core/util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> echartsAPIList = [</span><br><span class="line">  <span class="string">&#x27;getDom&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getZr&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getWidth&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getHeight&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getDevicePixelRatio&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;dispatchAction&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;isDisposed&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;on&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;off&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getDataURL&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getConnectedDataURL&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getModel&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getOption&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getViewOfComponentModel&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;getViewOfSeriesModel&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"><span class="comment">// And `getCoordinateSystems` and `getComponentByElement` will be injected in echarts.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ExtensionAPI</span>(<span class="params">chartInstance</span>) &#123;</span><br><span class="line">  zrUtil.<span class="title function_">each</span>(</span><br><span class="line">    echartsAPIList,</span><br><span class="line">    <span class="keyword">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>[name] = zrUtil.<span class="title function_">bind</span>(chartInstance[name], chartInstance);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="variable language_">this</span>,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ExtensionAPI</span>;</span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-calendar"></i><span class="date">2019-11-05</span><i class="fa fa-tag"></i><a href="/categories/web/" title="web" class="tag">web </a><a href="/tags/echarts/" title="echarts" class="tag">echarts </a><a href="/tags/zrender/" title="zrender" class="tag">zrender </a><a href="/tags/tooltip/" title="tooltip" class="tag">tooltip </a><a href="/tags/confine/" title="confine" class="tag">confine </a></div></div></div></div><div class="share"><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a target="_blank" rel="noopener" href="https://twitter.com/intent/tweet?url=https://zhengminhui.com/2019/9176cb10/&amp;text=é€šè¿‡ confine ç ”ç©¶ tooltip çš„å®ç°è¿‡ç¨‹ -- eCharts æºç è§£è¯»%20Â·%20Minhui's blog" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2020/38799c5f/" title="2020 Resolution" class="btn">prev post</a></li><li class="next pagbuttons"><a role="navigation" href="/2019/c505c167/" title="Node.js modules" class="btn">next post</a></li></ul></div></div></div></div></div></body></html>